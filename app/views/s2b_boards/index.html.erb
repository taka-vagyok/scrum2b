<% content_for :header_tags do %>
  <%= stylesheet_link_tag 'version', :plugin => 'scrum2b' %>
<% end %>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.15/angular.min.js"></script>
<script>
  var scrum2b = angular.module('scrum2b', []);
  scrum2b.controller('BoardsCtrl', function ($scope, listissues){
    listissues.list().then(
      function(data){
        var arrayissues = [];
        var arrayversions = [];
         angular.forEach(data.issues, function(value) {
           angular.forEach(value, function(value,key) {
             arrayissues.push(value);
            })
         })
         angular.forEach(data.versions, function(value) {
           angular.forEach(value, function(value,key) {
             arrayversions.push(value);
            })
         })
        console.log( "You clicked a paragraph!" + arrayversions);
        $scope.versions = arrayversions;
        $scope.issues = arrayissues;
      }
    )

    $scope.getIssues = function(version){
      listissues.getIssues(version.id).then(
        function(data){
          arrayissues = [];
          angular.forEach(data, function(value) {
            angular.forEach(value, function(value,key) {
              angular.forEach(value, function(value,key) {
                arrayissues.push(value);
              })
            })
          })
          $scope.issues = arrayissues;
          console.log( "You clicked a paragraph!" + arrayissues);
        }
      )
    }
  });
  
  scrum2b.service('listissues', function($http, $q){
    function getIssues(version_id){
       var request = $http({
        method: "post",
        url: "getissues",
        params: {
          action: "get"
        },
        data: {
          project_id: "<%= @project.id %>",
          version_id: version_id,
        },
      });
      return( request.then( handleSuccess, handleError ) );
    }
    function getData(callback){
        var request = $http({
        method: "post",
        url: "getdata",
        params: {
          action: "get"
        },
        data: {
          project_id: "<%= @project.id %>"
        },
      });
      return( request.then( handleSuccess, handleError ) );
    }

    return {
      list: getData,
      getIssues: getIssues,
    }
    function handleError ( response ){
      if (
          ! angular.isObject( response.data ) ||
          ! response.data.message
        ) {
        return ( $q.reject("false") );
      };

      return ( $q.reject( response.data.message ) );
    }

    function  handleSuccess( response ){
      return ( response.data );
    }
  });
</script>

<div ng-app="scrum2b" >
	<div class="content full_mode" ng-controller="BoardsCtrl">
	  <div  class="filter" >
	    <div class="filter_left">
	      <h3>Scrum2B Tool Demo prototype</h3>
	      <p>(Desktop suppork only)</p>
	    </div>

	    <div class="filter_right">
	      <ul >
	        <li>
	          <select>
	            <option ng-repeat="version in versions" value="{{ version.id }}">{{ version.name }}</option>
	          </select>
	        </li>
	        <li>
	          <select name="select_member" id="select_member">
	            <option value="all" ><%= l(:label_select_all_member)%></option>
	            <% if User.current.logged? %>
	             <option value="me" <% if session[:params_select_member] && session[:params_select_member] == "me" %><%= selected="selected" %><% end %>><%= l(:label_select_me)%></option>
	            <% end %>
	            <option ng-repeat="member in members" value=" {{ member.id }}">{{ member.name }}</option>
	          </select>
	        </li>
	        <li>
	        	<input type="button" value="Filter">
	        </li>
	      </ul>
	    </div>
	  </div> <!--end filter-->
	  <span class="icon_backlog">Backlog </span>
	  
	  <!-- Backlog -->
	  <%= render :partial => "/s2b_boards/backlog" %>
	  <!--begin 4 sprint-->
	  <div id="accordion" class="sprint_total">
  	  <%= render :partial => "/s2b_boards/sprint" %>
    </div><!--accordion-->
	</div><!--end content-->
</div>
<%= render :partial => "/s2b_boards/jquery" %>